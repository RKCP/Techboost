package com.vodafone.centralvulnerabilityreporting;

import com.vodafone.centralvulnerabilityreporting.entity.Blog;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Node;
import org.jsoup.select.Elements;

import java.io.File;
import java.io.IOException;
import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.SQLException;
import java.util.ArrayList;

public class CentralVulnerabilityReportingApplication {


    public static void main(String[] args) {
        scrapeFromHTML();
    }

    /**
     * Crawler web data
     */
    public static void scrapeFromHTML() {

        String title = "";

        // JSoup - Reading HTML page from URL
        Document doc = null;
        try {
            doc = Jsoup.connect("https://www.mrmoneymustache.com/2013/02/22/getting-rich-from-zero-to-hero-in-one-blog-post/").get();
        } catch (IOException e) {
            e.printStackTrace();
        }

        title = doc.title();
        Elements webpageText = doc.getElementsByClass("post_content");
        ArrayList<String> webpageParagraphs = new ArrayList<>();
        int count = 0;
        Node parentNode = webpageText.get(0);

        while (count < parentNode.childNodeSize()) {
            Node currentChildNode = parentNode.childNode(count);
            if (currentChildNode.toString().startsWith("<p>")) {
                webpageParagraphs.add(currentChildNode.toString());
            }
            count++;
        }

        // pass title, and text from array into db below..

        // for now just printing out rather than saving to db or logging.
        System.out.println(title);
        System.out.println(webpageParagraphs.size());


        // TODO: implement this with actual html security report
        // JSoup - Parsing an HTML file in Java
//        Document htmlFile = null;
//        try {
//            htmlFile = Jsoup.parse(new File("login.html"), "ISO-8859-1");
//        } catch (IOException e) {
//            e.printStackTrace();
//        } // right
//        title = htmlFile.title();
//        Element div = htmlFile.getElementById("login");
//        String cssClass = div.className(); // getting class form HTML element
//
//        System.out.println("Jsoup can also parse HTML file directly");
//        System.out.println("title : " + title);
//        System.out.println("class of div tag : " + cssClass);
    }

    /**
     * Database operation
     *
     * @param blog
     */
    public static void addToDatabase(Blog blog) throws SQLException {
        PreparedStatement preparedStatement = null;
        try (Connection connection = DriverManager.getConnection("jdbc:mysql://localhost:3306/jsoup?useSSL=true", "root", "1234")) {// need to replace url with GCP MySQL url

            // Write a SQL statement
            String sql = "INSERT INTO `content`(`title`, `href`, `author`, `reads`) VALUES (?,?,?,?)";
            preparedStatement = connection.prepareStatement(sql);
            preparedStatement.setString(1, blog.getTitle());
            preparedStatement.setString(2, blog.getHref());
            preparedStatement.setString(3, blog.getAuthor());
            preparedStatement.setString(4, blog.getReads());
            int result = preparedStatement.executeUpdate();
            // Verify that the data is added successfully
            if (result > 0) {
                System.out.println("Data Add success!");
            }
        } catch (SQLException throwables) {
            throwables.printStackTrace();
            System.out.println("Database Access Failed!");
        }
    }
}